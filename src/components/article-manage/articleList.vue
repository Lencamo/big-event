<template>
  <div class="articlList-container">
    <!-- Ê†∏ÂøÉÈ°µÈù¢ -->
    <el-card class="box-card">
      <div slot="header" class="clearfix">
        <span>ÊñáÁ´†ÂàóË°®</span>
      </div>
      <!-- ÊêúÁ¥¢Âå∫Âüü -->
      <div class="search-box">
        <el-form :inline="true" :model="q">
          <el-form-item label="ÊñáÁ´†ÂàÜÁ±ª">
            <el-select
              v-model="q.cate_id"
              placeholder="ËØ∑ÈÄâÊã©ÂàÜÁ±ª"
              size="small"
            >
              <!-- ÊñáÁ´†ÂàÜÁ±ªÈÄâÊã© - ÊêúÁ¥¢Ê†èÂå∫Âüü -->
              <!-- labelÊòØÈ°µÈù¢Â±ïÁ§∫ÁöÑÂÄºÔºåvalueÁöÑüö©ÂÄºÊòØÁªôjsË∞ÉÁî®ÂæÖ‰ΩøÁî®ÁöÑÊï∞ÊçÆ -->
              <el-option
                :label="item.cate_name"
                :value="item.id"
                v-for="item in cateList"
                :key="item.id"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="ÂèëÂ∏ÉÁä∂ÊÄÅ" style="margin-left: 15px">
            <el-select v-model="q.state" placeholder="ËØ∑ÈÄâÊã©Áä∂ÊÄÅ" size="small">
              <el-option label="Â∑≤ÂèëÂ∏É" value="Â∑≤ÂèëÂ∏É"></el-option>
              <el-option label="ËçâÁ®ø" value="ËçâÁ®ø"></el-option>
            </el-select>
          </el-form-item>
          <!-- Á≠õÈÄâ‰∏éÈáçÁΩÆ -->
          <el-form-item>
            <el-button type="primary" size="small" @click="onChooseFn"
              >Á≠õÈÄâ</el-button
            >
            <el-button type="info" size="small" @click="resetChooseFn"
              >ÈáçÁΩÆ</el-button
            >
          </el-form-item>
        </el-form>
        <!-- ÂèëË°®ÊñáÁ´†ÁöÑÊåâÈíÆ -->
        <el-button
          type="primary"
          size="small"
          class="btn-pub"
          @click="showPubDialogFn"
          >ÂèëË°®ÊñáÁ´†</el-button
        >
      </div>
      <!-- ‰∏ãÊñπÊñáÁ´†ÂàóË°®ÂÜÖÂÆπÂå∫Âüü -->
      <el-table :data="artList" style="width: 100%" border stripe>
        <el-table-column label="ÊñáÁ´†Ê†áÈ¢ò" prop="title"></el-table-column>
        <el-table-column label="ÂàÜÁ±ª" prop="cate_name"></el-table-column>
        <el-table-column label="ÂèëË°®Êó∂Èó¥" prop="pub_date">
          <!-- Â∑ßÁî®‚ú®ÊèíÊßΩËá™ÂÆö‰πâÊòæÁ§∫ÂÜÖÂÆπ -->
          <template slot-scope="scope">
            <span>{{ $formatDate(scope.row.pub_date) }}</span>
          </template>
        </el-table-column>
        <el-table-column label="Áä∂ÊÄÅ" prop="state"></el-table-column>
        <el-table-column label="Êìç‰Ωú"></el-table-column>
      </el-table>
      <!-- ÊñáÁ´†ÂàóË°®ÁöÑÂàÜÈ°µÂå∫Âüü -->
      <!-- ÂàÜÈ°µÂå∫Âüü -->
      <el-pagination
        @size-change="handleSizeChangeFn"
        @current-change="handleCurrentChangeFn"
        :current-page.sync="q.pagenum"
        :page-sizes="[2, 3, 5, 10]"
        :page-size.sync="q.pagesize"
        layout="total, sizes, prev, pager, next, jumper"
        :total="total"
      >
      </el-pagination>
    </el-card>

    <!-- ÂèëÂ∏ÉÊñáÁ´†-ÂØπËØùÊ°Ü -->
    <el-dialog
      title="ÂèëË°®"
      :visible.sync="pubdialogVisible"
      fullscreen
      :before-close="handleClose"
      @closed="dialogCloseFn"
    >
      <el-form
        :model="pubForm"
        :rules="pubFormRules"
        ref="pubFormRef"
        label-width="100px"
      >
        <el-form-item label="ÊñáÁ´†Ê†áÈ¢ò" prop="title">
          <el-input v-model="pubForm.title" placeholder="ËØ∑ËæìÂÖ•Ê†áÈ¢ò"></el-input>
        </el-form-item>
        <el-form-item label="ÊñáÁ´†ÂàÜÁ±ª" prop="cate_id">
          <el-select
            v-model="pubForm.cate_id"
            placeholder="ËØ∑ÈÄâÊã©ÂàÜÁ±ª"
            style="width: 100%"
          >
            <!-- ÊñáÁ´†ÂàÜÁ±ªÈÄâÊã© - ÂèëÂ∏ÉÊñáÁ´†Âå∫Âüü -->
            <!-- labelÊòØÈ°µÈù¢Â±ïÁ§∫ÁöÑÂÄºÔºåvalueÁöÑüö©ÂÄºÊòØÁªôjsË∞ÉÁî®ÂæÖ‰ΩøÁî®ÁöÑÊï∞ÊçÆÔºàpubForm.cata_idÔºâ -->
            <el-option
              :label="item.cate_name"
              :value="item.id"
              v-for="item in cateList"
              :key="item.id"
            >
            </el-option>
          </el-select>
        </el-form-item>
        <!-- ÂØåÊñáÊú¨ÁºñËæëÂô® -->
        <el-form-item label="ÊñáÁ´†ÂÜÖÂÆπ" prop="content">
          <quill-editor
            v-model="pubForm.content"
            @change="contentChangeFn"
          ></quill-editor>
        </el-form-item>
        <!-- ÊñáÁ´†Â∞ÅÈù¢ -->
        <el-form-item label="ÊñáÁ´†Â∞ÅÈù¢" prop="cover_img">
          <!-- Áî®Êù•ÊòæÁ§∫Â∞ÅÈù¢ÁöÑÂõæÁâá -->
          <img
            src="../../assets/images/cover.jpg"
            alt=""
            class="cover-img"
            ref="imgRef"
          />
          <br />
          <!-- Êñá‰ª∂ÈÄâÊã©Ê°ÜÔºåÈªòËÆ§Ë¢´ÈöêËóè -->
          <input
            type="file"
            style="display: none"
            accept="image/*"
            ref="iptFileRef"
            @change="onCoverChangeFn"
          />
          <!-- ÈÄâÊã©Â∞ÅÈù¢ÁöÑÊåâÈíÆ -->
          <el-button type="text" @click="chooseImgFn">+ ÈÄâÊã©Â∞ÅÈù¢</el-button>
        </el-form-item>
        <!-- ÂèëÂ∏É‰∏éÂ≠ò‰∏∫ËçâÁ®øÊåâÈíÆ -->
        <el-form-item>
          <el-button type="primary" @click="pubArticleFn('Â∑≤ÂèëÂ∏É')"
            >ÂèëÂ∏É</el-button
          >
          <el-button type="info" @click="pubArticleFn('ËçâÁ®ø')"
            >Â≠ò‰∏∫ËçâÁ®ø</el-button
          >
        </el-form-item>
      </el-form>
    </el-dialog>
  </div>
</template>

<script>
import {
  getArtCateListAPI,
  uploadArticleAPI,
  getArticleListAPI
} from '@/api/index'
// Ê≥®ÊÑè‚ú®Ôºöjs‰∏≠ÂºïÂÖ•ÂõæÁâáË¶ÅÊâÄ‰ª•import
import defaultImg from '@/assets/images/cover.jpg'

export default {
  name: 'articleList',
  data() {
    return {
      // ÊñáÁ´†ÂàÜÁ±ªÊï∞ÊçÆ
      cateList: [],
      // articleListÁªÑ‰ª∂ÁöÑÊü•ËØ¢ÂèÇÊï∞ÂØπË±°
      q: {
        pagenum: 1, // ÈªòËÆ§ÊòæÁ§∫Á¨¨‰∏ÄÈ°µÊï∞ÊçÆ
        pagesize: 5, // ÈªòËÆ§ÂΩìÂâçÈ°µÊòæÁ§∫Âá†Êù°Êï∞ÊçÆ
        cate_id: '',
        state: ''
      },
      // ÊñáÁ´†ÁöÑÂàóË°®Êï∞ÊçÆ
      artList: [],
      // ÊÄªÊï∞ÊçÆÊù°Êï∞
      total: 0,
      pubdialogVisible: false,
      // ÂèëÂ∏ÉÊñáÁ´†ÂØπËØùÊ°ÜË°®ÂçïÊï∞ÊçÆÂØπË±°
      pubForm: {
        title: '',
        cate_id: '',
        content: '',
        cover_img: null, // Áî®Êà∑ÈÄâÊã©ÁöÑÂ∞ÅÈù¢ÂõæÁâáÔºànull Ë°®Á§∫Ê≤°ÊúâÈÄâÊã©‰ªª‰ΩïÂ∞ÅÈù¢Ôºâ
        state: '' // ÊñáÁ´†ÁöÑÂèëÂ∏ÉÁä∂ÊÄÅÔºåÂèØÈÄâÂÄºÊúâ‰∏§‰∏™ÔºöËçâÁ®ø„ÄÅÂ∑≤ÂèëÂ∏É
      },
      // ÂèëÂ∏ÉÊñáÁ´†ÂØπËØùÊ°ÜË°®ÂçïÈ™åËØÅËßÑÂàôÂØπË±°
      pubFormRules: {
        // Ë°®ÂçïÁöÑÈ™åËØÅËßÑÂàôÂØπË±°
        title: [
          { required: true, message: 'ËØ∑ËæìÂÖ•ÊñáÁ´†Ê†áÈ¢ò', trigger: 'blur' },
          {
            min: 1,
            max: 30,
            message: 'ÊñáÁ´†Ê†áÈ¢òÁöÑÈïøÂ∫¶‰∏∫1-30‰∏™Â≠óÁ¨¶',
            trigger: 'blur'
          }
        ],
        cate_id: [
          // ‰ΩøÁî®change‰∫ã‰ª∂‚ú®ÂØπ‰∏ãÊãâËèúÂçïËøõË°åÊ†°È™å
          { required: true, message: 'ËØ∑ÈÄâÊã©ÊñáÁ´†Ê†áÈ¢ò', trigger: 'change' }
        ],
        content: [
          // Áî±‰∫équil-editorÊòØÂºïÂÖ•ÁöÑÔºå‰∏ç‰ºöËá™Âä®Ëµ∞Ê†°È™å
          // Ëß£ÂÜ≥ÂäûÊ≥ïÔºöÁî®ÂÆÉËá™Â∏¶Ëß¶ÂèëÂáΩÊï∞Èó¥Êé•ËøõË°åÊ†°È™å
          { required: true, message: 'ËæìÂÖ•ÊñáÁ´†ÂÜÖÂÆπ', trigger: 'blur' }
        ],
        cover_img: [
          // ËøôÈáåÁöÑÂõæÁâáÊ†°È™åÂíåÂâçÈù¢ÁöÑÂØåÊñáÊú¨Âô®Ê†°È™å‰∏ÄÊ†∑ÁöÑËß£ÂÜ≥ÊñπÊ≥ïÔºàÂçïÁã¨Ê†°È™åÔºâ
          { required: true, message: 'ËØ∑ÈÄâÊã©Â∞ÅÈù¢', trigger: 'blur' }
        ]
      }
    }
  },
  created() {
    // ËøõÂÖ•È°µÈù¢Êó∂Â∞± ËØ∑Ê±ÇÂàÜÁ±ªÊï∞ÊçÆ„ÄÅÂàóË°®Êï∞ÊçÆ
    this.getCateListFn()
    this.getArtListFn()
  },
  methods: {
    // Ëé∑ÂèñÊñáÁ´†ÂàÜÁ±ª
    async getCateListFn() {
      const { data: res } = await getArtCateListAPI()
      // console.log(res)
      this.cateList = res.data
    },
    // Ëé∑ÂèñÊñáÁ´†ÂàóË°®
    async getArtListFn() {
      const { data: res } = await getArticleListAPI(this.q)

      // console.log(res)
      if (res.code !== 0) return this.$message.error('Ëé∑ÂèñÊñáÁ´†ÂàóË°®Â§±Ë¥•!')
      this.artList = res.data
      this.total = res.total
    },

    // ÂèëË°®ÊñáÁ´†-Ëß¶ÂèëÊåâÈíÆ
    // ‰ΩøÁî®dialogÂØπËØùÊ°Üü§îÔºàÂà†Èô§‰∫ÜÁ°ÆËÆ§„ÄÅÂèñÊ∂àÊåâÈíÆÔºâ
    showPubDialogFn() {
      this.pubdialogVisible = true
    },
    // ÂèëË°®ÊñáÁ´†-ÂØπËØùÊ°ÜÂÖ≥Èó≠ÂâçÁöÑÂõûË∞Éüö©
    // Ëøô‰∏™ÊñπÊ≥ïÂ∞Ü‰ª£ÊõøÂéüÂÖàdialogÂØπËØùÊ°ÜÁöÑÁ°ÆËÆ§„ÄÅÂèñÊ∂àÊåâÈíÆ
    handleClose(done) {
      // ‰ΩøÁî®element-uiÁöÑMessageBoxÂºπÊ°ÜÔºàÂâçÈù¢ÈÄÄÂá∫ÂäüËÉΩ‰πüÁî®ËøáÔºâ
      // ËøôÈáå‰ªéÂºÇÊ≠•ÁöÑËßíÂ∫¶ÂàÜÊûê
      // const confirmResult = await this.$confirm(‚Ä¶‚Ä¶)
      this.$confirm('Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§ËØ•Êñá‰ª∂, ÊòØÂê¶ÁªßÁª≠?', 'ÊèêÁ§∫', {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      })
        // Ëã•ÈÄâÊã©Á°ÆÂÆöÁöÑÊìç‰Ωú
        .then(() => {
          // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
          done()
        })
        // Ëã•ÈÄâÊã©ÂèñÊ∂àÁöÑÊìç‰Ωú
        .catch(() => {
          this.$message.success('Â∑≤ÂèñÊ∂àÔºÅ')
        })
    },
    // Èó¥Êé•‰ª£ÊõøÊñá‰ª∂ÈÄâÊã©Ê°ÜÁöÑÁÇπÂáª‰∫ã‰ª∂
    chooseImgFn() {
      this.$refs.iptFileRef.click()
    },
    // Â∞ÅÈù¢ÈÄâÊã©ÊîπÂèòÁöÑ‰∫ã‰ª∂ÔºàÂõæÁâáÈ¢ÑËßàÔºöËøôÈáåÈááÁî®Á¨¨‰∫åÁßçÊñπÂºè „ÄêÊ≥®ÊÑèÊØîËæÉ‰∏éÂâçÈù¢ÁöÑÂõæÁâáÈ¢ÑËßàÊâÄ‰ª•ÁöÑÂå∫Âà´„ÄëÔºâ
    onCoverChangeFn(e) {
      // Ëé∑ÂèñÁî®Êà∑ÈÄâÊã©ÁöÑÊñá‰ª∂ÂàóË°®
      const files = e.target.files
      if (files.length === 0) {
        // Áî®Êà∑Ê≤°ÊúâÈÄâÊã©Â∞ÅÈù¢
        this.pubForm.cover_img = null

        this.$refs.imgRef.setAttribute('src', defaultImg)
      } else {
        // Áî®Êà∑ÈÄâÊã©‰∫ÜÂ∞ÅÈù¢
        this.pubForm.cover_img = files[0]
        const url = URL.createObjectURL(files[0])
        this.$refs.imgRef.setAttribute('src', url)
      }

      // Â∞ÅÈù¢ÂõæÁâáÂçïÁã¨Ê†°È™åËß£ÂÜ≥
      this.$refs.pubFormRef.validateField('cover_img')
    },
    // ÂèëÂ∏ÉÊñáÁ´†ÊàñËçâÁ®ø-ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
    pubArticleFn(str) {
      // 1. ËÆæÁΩÆÂèëÂ∏ÉÁä∂ÊÄÅ
      this.pubForm.state = str

      // // 2. Ë°®ÂçïÈ¢ÑÊ†°È™åÔºàÂÖúÂ∫ïÊ†°È™åÔºâ
      this.$refs.pubFormRef.validate(async (valid) => {
        if (valid) {
          // ÂàõÂª∫ FormData Ë°®ÂçïÊï∞ÊçÆÂØπË±°
          // FormDataÁ±ªÊòØTHML5ÁöÑÂÜÖÂÆπÔºàÊòØ‰∏Ä‰∏™Áî®‰∫éË£ÖÊñá‰ª∂ÁöÑÂÆπÂô®Ôºâ
          const fd = new FormData()

          // Âêë FormData ‰∏≠ËøΩÂä†Êï∞ÊçÆ
          // ÊñπÂºè1
          // fd.append('title', this.pubForm.title)
          // fd.append('cate_id', this.pubForm.cate_id)
          // fd.append('content', this.pubForm.content)
          // fd.append('cover_img', this.pubForm.cover_img)
          // fd.append('state', this.pubForm.state)
          // ÊñπÂºè2Ôºö‰ΩøÁî®Object.keysÂä†forEach()
          Object.keys(this.pubForm).forEach((key) => {
            fd.append(key, this.pubForm[key])
          })
          console.log(fd)
          // ÂèëËµ∑ËØ∑Ê±Ç
          const { data: res } = await uploadArticleAPI(fd)
          console.log(res)
          if (res.code !== 0) {
            this.$message.error('ÂèëÂ∏ÉÊñáÁ´†Â§±Ë¥•ÔºÅ')
          } else {
            this.$message.success('ÂèëÂ∏ÉÊñáÁ´†ÊàêÂäüÔºÅ')

            // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
            this.pubdialogVisible = false

            // Âà∑Êñ∞‰∏ªÈ°µÈù¢ÊñáÁ´†ÂàóË°®Êï∞ÊçÆ
            this.getArtListFn()
          }
        } else {
          return false
        }
      })
    },
    // ‰ΩøÁî®element-ui‰∏≠ÁöÑvalidateField()ÊñπÊ≥ïËÆ©ÂØåÊñáÊú¨ÁºñËæëÂô®ÂÆûÁé∞Ê†°È™åÂäüËÉΩ
    contentChangeFn() {
      // validateField()ÂØπÈÉ®ÂàÜË°®ÂçïÂ≠óÊÆµËøõË°åÊ†°È™åÁöÑÊñπÊ≥ï
      this.$refs.pubFormRef.validateField('content')
    },
    // ÂèëÂ∏ÉÊñáÁ´†ÊàñËçâÁ®øÂêéÁöÑÊìç‰Ωú
    dialogCloseFn() {
      // Ê∏ÖÁ©∫ÂÖ≥ÈîÆÊï∞ÊçÆ
      this.$refs.pubFormRef.resetFields()
      // Âõ†‰∏∫Ëøô2‰∏™ÂèòÈáèÂØπÂ∫îÁöÑÊ†áÁ≠æ‰∏çÊòØË°®ÂçïÁªëÂÆöÁöÑ, ÊâÄ‰ª•ÈúÄË¶Å‚ú®ÂçïÁã¨ÊéßÂà∂
      this.pubForm.content = ''
      this.$refs.imgRef.setAttribute('src', defaultImg)
    },
    // ÊñáÁ´†ÂàóË°®Êù°Êï∞ÂèëÁîüÊîπÂèòÊó∂(element-uiÂÜÖÁΩÆÂõûË∞ÉÂèÇÊï∞)
    handleSizeChangeFn(newSize) {
      // ‰∏∫ pagesize ËµãÂÄº
      this.q.pagesize = newSize

      // ÈáçÊñ∞ÂèëËµ∑ËØ∑Ê±Ç
      this.getArtListFn()
    },
    // ÊñáÁ´†ÂàóË°®È°µÊï∞Êï∞ÂèëÁîüÊîπÂèòÊó∂(element-uiÂÜÖÁΩÆÂõûË∞ÉÂèÇÊï∞)
    handleCurrentChangeFn(newPage) {
      // ‰∏∫È°µÁ†ÅÂÄºËµãÂÄº
      this.q.pagenum = newPage
      // ÈáçÊñ∞ÂèëËµ∑ËØ∑Ê±Ç
      this.getArtListFn()
    },
    // Ëß¶ÂèëÁ≠õÈÄâÊñáÁ´†ÊåâÈíÆ
    onChooseFn() {
      this.getArtListFn()
    },
    // Ëß¶ÂèëÈáçÁΩÆÊñáÁ´†Á≠õÈÄâÊåâÈíÆ
    resetChooseFn() {
      // 1. ÈáçÁΩÆÊü•ËØ¢ÂèÇÊï∞ÂØπË±°
      this.q = {
        pagenum: 1,
        pagesize: 5,
        cate_id: '',
        state: ''
      }
      // 2. ÈáçÊñ∞ÂèëËµ∑ËØ∑Ê±Ç
      this.getArtListFn()
    }
  }
}
</script>
<style lang="less" scoped>
.articlList-container {
  .search-box {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    .btn-pub {
      margin-top: 5px;
    }
  }
}
// ËÆæÁΩÆÂØåÊñáÊú¨ÁºñËæëÂô®ÁöÑÈªòËÆ§ÊúÄÂ∞èÈ´òÂ∫¶
// ::v-deep‰ΩúÁî®: Á©øÈÄèÈÄâÊã©, Ê≠£Â∏∏style‰∏äÂä†‰∫ÜscopeÁöÑËØù, ‰ºöÁªô.ql-editor[data-v-hash]Â±ûÊÄß, Âè™ËÉΩÈÄâÊã©ÂΩìÂâçÈ°µÈù¢Ê†áÁ≠æÊàñËÄÖÁªÑ‰ª∂ÁöÑÊ†πÊ†áÁ≠æ
// Â¶ÇÊûúÊÉ≥Ë¶ÅÈÄâÊã©ÁªÑ‰ª∂ÂÜÖÁöÑÊ†áÁ≠æ(ÈÇ£‰∫õÊ†áÁ≠æÊ≤°Êúâdata-v-hashÂÄº)ÊâÄ‰ª•Ê≠£Â∏∏ÈÄâÊã©ÈÄâ‰∏ç‰∏≠, Âä†‰∫Ü::v-deepÁ©∫Ê†ºÂâçÁΩÆÁöÑËØù, ÈÄâÊã©Âô®Â∞±‰ºöÂèòÊàêÂ¶Ç‰∏ãÂΩ¢Âºè
// [data-v-hash] .ql-editor ËøôÊ†∑Â∞±ËÉΩÈÄâ‰∏≠ÁªÑ‰ª∂ÂÜÖÁöÑÊ†áÁ≠æÁöÑclassÁ±ªÂêç‰∫Ü
::v-deep .ql-editor {
  min-height: 300px;
}

// ËÆæÁΩÆÂõæÁâáÂ∞ÅÈù¢ÁöÑÂÆΩÈ´ò
.cover-img {
  width: 400px;
  height: 280px;
  object-fit: cover;
}

// ÊñáÁ´†ÂàóË°®Ê†∑Âºè
.el-pagination {
  margin-top: 15px;
}
</style>
